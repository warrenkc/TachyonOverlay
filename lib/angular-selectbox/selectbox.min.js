"use strict";angular.module("selectbox",[]).filter("contains",[function(){return function(e,i){return-1!==e.indexOf(i)}}]).service("SelectBox",[function(){return{counter:0,init:function(){this.counter+=1}}}]).controller("SelectBoxCtrl",["$scope","$document","$element","SelectBox",function(e,i,t,n){n.init(),e.view={},e.view.show=!1,e.view.tabindex=n.counter,e.view.instanceId="inst-"+Date.now();var l=function(i){var t=angular.element(i.target),n=t.attr("id"),l=e.multi&&"undefined"==typeof n&&t.hasClass("mad-selectbox-item");return e.view.instanceId===n||l?!1:(e.view.show=!1,e.$apply(),void o())},c=function(i){if(-1!==[13,32].indexOf(i.keyCode)&&"undefined"!=typeof e.view.focus)return e.selectItem(e.view.focus),e.multi||(o(),e.view.show=!1),e.$apply(),!1;if(-1===[38,40].indexOf(i.keyCode))return!1;var n=0,l=e.list.length-1;e.view.focus="undefined"==typeof e.view.focus?-1:e.view.focus,40===i.keyCode&&(e.view.focus===l?e.view.focus=n:e.view.focus+=1),38===i.keyCode&&(e.view.focus<=n?e.view.focus=l:e.view.focus-=1),e.$apply();var c=t[0].querySelector(".mad-selectbox-dropdown"),s=c.querySelector(".focus"),d=c.offsetHeight,u=s.offsetHeight*(e.view.focus+1);u>=d?c.scrollTop=u:u<=c.scrollTop&&(c.scrollTop=0)},s=function(){"undefined"!=typeof e.list&&(e.view.selected=e.multi?e.index:e.list[e.index])};e.toggleList=function(){e.view.show=!e.view.show,e.view.show?(i.bind("click",l),t.on("keydown",c)):o()},e.selectItem=function(i){if(e.multi){var t=e.list[i].id,n=e.view.selected.indexOf(t);if(-1!==n){if(e.view.selected.length<=parseInt(e.min,10))return!1;e.view.selected.splice(n,1)}else e.view.selected.push(t);e.index=e.view.selected}else e.view.selected=e.list[i],e.index=i},s(),e.$watch("list.length",function(e,i){e!==i&&s()}),e.$watch("index",function(i,t){s();i!==t&&(e.handler())});var o=function(){e.view.focus=-1,i.unbind("click",l),t.off("keydown",c)};e.$on("$destroy",function(){o()})}]).directive("selectbox",[function(){return{restrict:"E",replace:!0,scope:{list:"=",index:"=ngModel",multi:"@",title:"@",min:"@",handler:"&"},controller:"SelectBoxCtrl",template:'<div tabindex="{{ view.tabindex }}" class="mad-selectbox" ng-class="{\'mad-selectbox-multi\': multi}"><a href id="{{ view.instanceId }}"class="mad-selectbox-toggle"ng-click="toggleList()"ng-class="{active: view.show}">{{ multi ? (title || \'Select\') : (view.selected.name || view.selected || \'Select\') }}</a><ul class="mad-selectbox-dropdown" ng-show="view.show"><li ng-repeat="item in list track by $index"ng-class="{active: multi ? (view.selected | contains:item.id) : ($index === index), focus: ($index === view.focus)}"><a href class="mad-selectbox-item {{item.class}}" ng-click="selectItem($index)">{{ item.name || item }}</a></li><li class="mad-empty" ng-if="list.length === 0">the list is empty</li></ul></div>'}}]);
